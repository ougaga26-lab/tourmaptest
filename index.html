async function toggleAudio() {
  if (!currentPoint) {
    alert('請先選擇一個景點');
    return;
  }

  const button = document.getElementById('audio-button');
  const text = document.getElementById('audio-text');
  const audioEl = document.getElementById('ttsAudio');
  const audioHint = document.getElementById('audioHint');

  // 停止
  if (isPlaying) {
    audioEl.pause();
    audioEl.currentTime = 0;

    if (currentAudioUrl) { URL.revokeObjectURL(currentAudioUrl); currentAudioUrl = null; }
    audioEl.src = '';
    audioEl.style.display = 'none';
    audioHint.style.display = 'none';

    isPlaying = false;
    button.classList.remove('playing');
    text.textContent = '朗讀介紹';
    return;
  }

  // 生成 + 播放
  try {
    button.disabled = true;
    text.textContent = '生成中...';

    // 叫後端生成音檔
    const response = await fetch('/api/tts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: currentPoint.description,
        version: 'Sota',
        speaker: '文彬',
        style: '預設',
        speed: 1,
        pitch_shift: 0,
        style_weight: 0,
        breath_pause: 0.3
      })
    });

    if (!response.ok) throw new Error(`API request failed: ${response.status}`);

    const audioBlob = await response.blob();
    const audioUrl = URL.createObjectURL(audioBlob);

    // 塞到 audio 元素
    if (currentAudioUrl) URL.revokeObjectURL(currentAudioUrl);
    currentAudioUrl = audioUrl;

    audioEl.src = audioUrl;
    audioEl.style.display = 'block';

    // LINE 內建瀏覽器：不要用 JS 強制 play，改用提示 + 讓使用者按 controls 播放
    if (isLineInAppBrowser()) {
      audioHint.style.display = 'block';
      button.disabled = false;
      text.textContent = '請按下方播放鍵';
      // 不設定 isPlaying，因為是否在播由使用者控制列決定
      return;
    }

    // 非 LINE：正常嘗試播放
    await audioEl.play();

    isPlaying = true;
    button.classList.add('playing');
    button.disabled = false;
    text.textContent = '停止播放';

    audioEl.onended = () => {
      isPlaying = false;
      button.classList.remove('playing');
      text.textContent = '朗讀介紹';
      if (currentAudioUrl) { URL.revokeObjectURL(currentAudioUrl); currentAudioUrl = null; }
      audioEl.style.display = 'none';
      audioHint.style.display = 'none';
    };

  } catch (error) {
    console.error(error);
    button.disabled = false;
    text.textContent = '朗讀介紹';

    // 如果是 play 被擋，給更精準提示
    const msg = String(error?.message || error);
    if (msg.includes('not allowed') || msg.includes('NotAllowedError')) {
      audioEl.style.display = 'block';
      audioHint.style.display = 'block';
      alert('此瀏覽器限制自動播放。請改用下方音訊播放器按 ▶︎ 播放，或右上角用 Safari 開啟。');
    } else {
      alert('語音生成失敗：' + msg);
    }
  }
}
